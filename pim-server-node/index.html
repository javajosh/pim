<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="googlebot" content="noindex">
  <title>Simpatico</title>

  <link rel="icon" href="/icon/favicon.ico" sizes="any"><!-- 32×32 -->
  <link rel="icon" href="/icon/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icon/apple-touch-icon.png"><!-- 180×180 -->
  <link rel="manifest" href="/icon/manifest.webmanifest">

  <noscript>
    <h3>Simpatico requires javascript to be enabled</h3>
    <p>That said there are more important things than Simpatico. Go outside and enjoy nature.</p>
  </noscript>

</head>
<body>

<img src="./icon/icon.svg" width="100px" alt="a very fancy logo with 3 loops and 6 linked circles" >

<script type="module">
  import { combine } from './simpatico/combine.js';

  const load = false;
  const has = key => !!localStorage.getItem(key);
  const get = key => localStorage.getItem(key);
  const set = (key,value) => localStorage.setItem(key, value);

  const state = has(window.origin) && load ? JSON.parse(get(window.origin)) : {
    origin: window.origin,
    homepage: "simpatico.io",
    version: "1.0",
    description: "Open a websocket and keep it up; track some lifetime stats",
    mouse: {
      events:[],
      move: 0,
    },
    webSocket: {
      readyState: 0,
      open: 0,
      error: 0, errorLog: [],
      message: 0, lastMessage: "",
      close: 0,
      started: 'time',
      stopped: 'time',
      uptime: 0,
    }
  };
  window.state = state; window.combine = combine; //expose state to global repl for adhoc usage

  // Create a new WebSocket
  const wsProto = (window.location.protocol === "https:") ? "wss://" : "ws://";
  const webSocketURL = wsProto + window.location.host + "/ws";
  const socket = new WebSocket(webSocketURL, ['json']);
  socket.onopen = e => {
    console.log('client>> socket.onopen() e.target.url = %s', e.target.url);
    state.webSocket = combine(state.webSocket, {open: 1, started: Date.now() + ''}); //stringify the number to ensure it replaces, and doesn't add
    set(window.origin, JSON.stringify(state));
    socket.send('hello from client');
  }
  socket.onclose = _ => {
    const started = state.webSocket.started;
    const stopped = Date.now() + ''; //stringify the number to ensure it replaces, and doesn't add
    const uptime = 1 * stopped - 1 * started;
    console.log('client>> socket.onclose() -  {started, stopped, uptime, close} = {%s, %s, %s, %s}', started, stopped, uptime, state.webSocket.close);
    state.webSocket = combine(state.webSocket, {close: 1, stopped, uptime, currentSocket: null});
    set(window.origin, JSON.stringify(state));
  }
  socket.onerror = e => {
    console.log('client>> socket.onerror %s', e);
    state.webSocket = combine(state.webSocket, {error: 1, errorLog: [e]});
  }
  socket.onmessage = e => {
    console.log('client>> socket.onmessage %s', e.data);
    state.webSocket = combine(state.webSocket, {message: 1, lastMessage: e.data.toString()});

  }
  state.currentSocket = socket; //expose socket to global repl

  // Listen for mouse events
  window.onmousemove = ({type = "mousemove", x, y, movementX: dx, movementY :dy, target}) => {
    const event = {type, x, y, dx, dy, target};
    //console.log(event);
    state.mouse = combine(state.mouse, {move: 1, events: event});
  }
  // aside: pulling important values out of an object, 2 ways
  // 1. Destructuring. Great if you only need to pluck things out of the larger object. Bad if you need to do more.
  // 2. Pure function that takes the original object and returns a new, unique object with only concrete values.
  // (This object may be recorded, directly or indirectly, which constrains what may be in it. Stick with dead data, JSON.)

</script>
</body>
</html>
