<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Welcome</title>
</head>
<body>

<script type="module">
  import { combine } from './simpatico/combine.js';

  const has = key => !!localStorage.getItem(key);
  const get = key => localStorage.getItem(key);
  const put = (key,value) => localStorage.setItem(key, value);

  const state = has(window.origin) ? JSON.parse(get(window.origin)) : {
    origin: window.origin,
    homepage: "simpatico.io",
    version: "1.0",
    description: "Open a websocket and keep it up; track some lifetime stats",
    webSocket: {
      readyState: 0,
      open: 0,
      error: 0, errorLog: [],
      message: 0, lastMessage: "",
      close: 0,
      started: 'time',
      stopped: 'time',
      uptime: 0,
    }
  };
  window.state = state; window.combine = combine; //expose for adhoc usage

  const wsProto = (window.location.protocol === "https:") ? "wss://" : "ws://";
  const webSocketURL = wsProto + window.location.host + "/ws";

  const socket = new WebSocket(webSocketURL,['json']);
  socket.onopen = () => {
    state.webSocket = combine(state.webSocket, {open: 1, started: Date.now() + ''}); //stringify the number to ensure it replaces, and doesn't add
    put(window.origin, JSON.stringify(state));
  }
  socket.onclose = () => {
    const started = state.webSocket.started;
    const stopped = Date.now() + ''; //stringify the number to ensure it replaces, and doesn't add
    const uptime = 1 * stopped - 1 * started;
    state.webSocket = combine(state.webSocket, {close: 1, stopped, uptime, currentSocket: null});
    put(window.origin, JSON.stringify(state));
  }
  socket.onerror = e => {
    state.webSocket = combine(state.webSocket, {error: 1, errorLog: [e.data]});
  }
  socket.onmessage = e => {
    console.log('onmessage %s', e.data);
    state.webSocket = combine(state.webSocket, {message: 1, lastMessage: e.data});

  }
  state.currentSocket = socket;

  // Now you can send things to the server with socket.send(msg)
  // To receive, it's the body of onmessage.

</script>
</body>
</html>
